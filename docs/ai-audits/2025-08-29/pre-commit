#!/bin/bash
# Pre-commit hook: Prevent awareness state files outside docs/awareness/

set -e

# Define awareness state files that must only exist in docs/awareness/
AWARENESS_FILES=(
  "NOW.md"
  "NEXT.md" 
  "STATUS.md"
  "AI_WORK_LOG.md"
  "AI_DISCUSSION_SPACE.md"
  "REGISTRY.yml"
  "LOST_AND_FOUND.md"
)

# Check for awareness files outside docs/awareness/
violations=()

for file in "${AWARENESS_FILES[@]}"; do
  # Find any instance of the file outside docs/awareness/
  found=$(find . -name "$file" -not -path "./docs/awareness/$file" -not -path "./.git/*" 2>/dev/null || true)
  
  if [ -n "$found" ]; then
    while IFS= read -r path; do
      violations+=("$path")
    done <<< "$found"
  fi
done

if [ ${#violations[@]} -gt 0 ]; then
  echo "❌ COMMIT BLOCKED: Awareness state files found outside docs/awareness/"
  echo ""
  echo "The following files violate the awareness namespace policy:"
  for violation in "${violations[@]}"; do
    echo "  - $violation"
  done
  echo ""
  echo "Awareness state files must only exist in: docs/awareness/"
  echo ""
  echo "To fix this:"
  echo "  1. Move files to docs/awareness/ using: git mv <file> docs/awareness/<file>"  
  echo "  2. Or remove duplicates using: git rm <file>"
  echo ""
  exit 1
fi

echo "✅ Awareness namespace policy: PASSED"