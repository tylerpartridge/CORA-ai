{% extends "base_app.html" %}
{% block content %}
<div class="container py-4 referral-program">
  <h1>üéÅ Give $50, Get $50</h1>
  <p class="text-muted">Share CORA and both get rewarded.</p>
  
  <!-- Login Status Indicator -->
  <div id="auth-status" class="alert alert-info" style="display:none;">
    <strong>Status:</strong> <span id="auth-message">Checking authentication...</span>
  </div>
  <div class="row my-4">
    <div class="col-md-6">
      <label class="form-label">Your referral link</label>
      <div class="input-group">
        <input id="referral-link" class="form-control" readonly value="Loading...">
        <button class="btn btn-outline-warning" onclick="copyLink()">Copy</button>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-sm btn-primary" onclick="shareTwitter()">Share on Twitter</button>
        <button class="btn btn-sm btn-secondary" onclick="shareEmail()">Email Friends</button>
      </div>
    </div>
    <div class="col-md-6">
      <label class="form-label">Invite by email</label>
      <textarea id="email-list" class="form-control" rows="5" placeholder="one email per line"></textarea>
      <button class="btn btn-success mt-2" onclick="sendInvites()">Send Invitations</button>
    </div>
  </div>
  <div class="row mt-4">
    <div class="col-md-4"><div class="card p-3"><h3 id="successful-referrals">0</h3><p>Successful Referrals</p></div></div>
    <div class="col-md-4"><div class="card p-3"><h3 id="total-earned">$0</h3><p>Total Earned</p></div></div>
  </div>
</div>
<script>
async function loadReferral(){ 
  const statusDiv = document.getElementById('auth-status');
  const statusMsg = document.getElementById('auth-message');
  statusDiv.style.display = 'block';
  
  try {
    const r = await fetch('/api/referral/my-code');
    
    if (!r.ok) {
      if (r.status === 401) {
        statusDiv.className = 'alert alert-warning';
        statusMsg.textContent = 'You need to login first! Redirecting to login page...';
        setTimeout(() => {
          window.location.href = '/login?next=/referral';
        }, 2000);
        return;
      }
      throw new Error(`HTTP ${r.status}`);
    }
    
    const d = await r.json();
    
    // Success - user is logged in
    statusDiv.className = 'alert alert-success';
    statusMsg.textContent = 'Logged in successfully! Your referral code is loaded below.';
    
    // Update the UI with data
    document.getElementById('referral-link').value = d.link || 'Error loading link';
    document.getElementById('successful-referrals').textContent = d.successful_referrals || 0;
    document.getElementById('total-earned').textContent = '$' + ((d.successful_referrals || 0) * 50);
    
  } catch (error) {
    statusDiv.className = 'alert alert-danger';
    statusMsg.textContent = `Error: ${error.message}. Please try logging in at /login`;
    document.getElementById('referral-link').value = 'Login required';
  }
}
function copyLink(){ const i=document.getElementById('referral-link'); i.select(); document.execCommand('copy'); }
function shareTwitter(){ const l=document.getElementById('referral-link').value; const t="I'm saving $12k/year with CORA! Join me and we both get $50:"; window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(l)}`); }
function shareEmail(){ const l=document.getElementById('referral-link').value; window.location.href=`mailto:?subject=Try CORA&body=Join me on CORA: ${encodeURIComponent(l)}`; }
async function sendInvites(){ const emails=document.getElementById('email-list').value.split('\n').map(e=>e.trim()).filter(Boolean); if(!emails.length) return; const r=await fetch('/api/referral/send-invite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(emails)}); if(r.ok){ document.getElementById('email-list').value=''; alert('Invitations sent!'); } }
document.addEventListener('DOMContentLoaded', loadReferral);
</script>
{% endblock %}


