{% extends "base_app.html" %}

{% block page_title %}QuickBooks Integration - CORA{% endblock %}

{% block page_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<!-- Legacy wellness.css removed; rely on base_app theme -->
<link rel="stylesheet" href="/static/css/mobile-navigation.css">
<style>
  .card-hover{transition:transform .2s ease, box-shadow .2s ease}
  .card-hover:hover{transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,0.08)}
  .status-connected{background:#16a34a}
  .status-disconnected{background:#ef4444}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-8">
    <div class="flex items-center mb-4">
      <img src="/static/images/logos/integrations/quickbooks-logo.svg" alt="QuickBooks" class="h-12 w-auto mr-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-100">QuickBooks Integration</h1>
        <p class="text-gray-300">Sync your expenses automatically with QuickBooks</p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Connection Status</h3>
        <div id="status-indicator" class="w-3 h-3 rounded-full"></div>
      </div>
      <div id="connection-info"><p class="text-sm text-gray-600 mb-2">Checking connection...</p></div>
      <div class="mt-4">
        <button id="connect-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors hidden"><i class="fas fa-plug mr-2"></i>Connect QuickBooks</button>
        <button id="disconnect-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors hidden"><i class="fas fa-unlink mr-2"></i>Disconnect</button>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Sync Statistics</h3>
      <div class="space-y-3">
        <div class="flex justify-between"><span class="text-sm text-gray-600">Total Synced:</span><span id="total-synced" class="font-semibold">-</span></div>
        <div class="flex justify-between"><span class="text-sm text-gray-600">Last Sync:</span><span id="last-sync" class="font-semibold">-</span></div>
        <div class="flex justify-between"><span class="text-sm text-gray-600">Auto Sync:</span><span id="auto-sync" class="font-semibold">-</span></div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
      <div class="space-y-3">
        <button id="sync-all-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-sync mr-2"></i>Sync All Expenses</button>
        <button id="test-connection-btn" class="w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors"><i class="fas fa-wifi mr-2"></i>Test Connection</button>
      </div>
    </div>
  </div>

  <div id="sync-progress" class="bg-white rounded-lg shadow-sm border p-6 mb-8 hidden">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Sync Progress</h3>
    <div class="space-y-4">
      <div class="flex justify-between text-sm"><span id="sync-status">Preparing sync...</span><span id="sync-count">0 / 0</span></div>
      <div class="w-full bg-gray-200 rounded-full h-2"><div id="sync-bar" class="bg-blue-600 h-2 rounded-full sync-progress" style="width:0%"></div></div>
      <div id="sync-errors" class="text-sm text-red-600 hidden"></div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm border">
    <div class="px-6 py-4 border-b"><h3 class="text-lg font-semibold text-gray-900">Sync History</h3></div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50"><tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
        </tr></thead>
        <tbody id="sync-history" class="bg-white divide-y divide-gray-200"><tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading sync history...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
let isConnected=false, syncInProgress=false;
const statusIndicator=document.getElementById('status-indicator');
const connectionInfo=document.getElementById('connection-info');
const connectBtn=document.getElementById('connect-btn');
const disconnectBtn=document.getElementById('disconnect-btn');
const syncAllBtn=document.getElementById('sync-all-btn');
const testConnectionBtn=document.getElementById('test-connection-btn');
const syncProgress=document.getElementById('sync-progress');
const syncStatus=document.getElementById('sync-status');
const syncCount=document.getElementById('sync-count');
const syncBar=document.getElementById('sync-bar');
const syncErrors=document.getElementById('sync-errors');
const syncHistory=document.getElementById('sync-history');

document.addEventListener('DOMContentLoaded',()=>{ loadConnectionStatus(); loadSyncHistory(); });
connectBtn?.addEventListener('click', connectQuickBooks);
disconnectBtn?.addEventListener('click', disconnectQuickBooks);
syncAllBtn?.addEventListener('click', syncAllExpenses);
testConnectionBtn?.addEventListener('click', testConnection);

async function loadConnectionStatus(){
  try{ const res=await fetch('/api/integrations/quickbooks/status'); const data=await res.json(); isConnected=data.is_connected; updateConnectionUI(data);}catch(e){ console.error('Failed to load connection status:',e); updateConnectionUI({is_connected:false}); }
}

function updateConnectionUI(data){
  if(data.is_connected){
    statusIndicator.className='w-3 h-3 rounded-full status-connected';
    const name=(window.CORASecurity?.sanitizeHtml?.(data.company_name)||data.company_name)||'QuickBooks Company';
    connectionInfo.innerHTML=`<p class='text-sm text-gray-600 mb-2'>Connected to:</p><p class='font-semibold text-gray-900'>${name}</p>`;
    connectBtn.classList.add('hidden');
    disconnectBtn.classList.remove('hidden');
    syncAllBtn.disabled=false;
    document.getElementById('total-synced').textContent=data.total_expenses_synced||0;
    document.getElementById('last-sync').textContent=data.last_sync_at?new Date(data.last_sync_at).toLocaleDateString():'Never';
    document.getElementById('auto-sync').textContent=data.auto_sync_enabled?'Enabled':'Disabled';
  } else {
    statusIndicator.className='w-3 h-3 rounded-full status-disconnected';
    connectionInfo.innerHTML='<p class="text-sm text-gray-600">Not connected to QuickBooks</p>';
    connectBtn.classList.remove('hidden');
    disconnectBtn.classList.add('hidden');
    syncAllBtn.disabled=true;
    document.getElementById('total-synced').textContent='-';
    document.getElementById('last-sync').textContent='-';
    document.getElementById('auto-sync').textContent='-';
  }
}

async function connectQuickBooks(){
  try{ const res=await fetch('/api/integrations/quickbooks/auth'); const data=await res.json(); if(data.auth_url){ window.location.href=data.auth_url;} else { throw new Error('Failed to get auth URL'); } }
  catch(e){ console.error('Failed to connect:',e); alert('Failed to connect to QuickBooks. Please try again.'); }
}

async function disconnectQuickBooks(){
  if(!confirm('Are you sure you want to disconnect QuickBooks?')) return;
  try{ const res=await fetch('/api/integrations/quickbooks/disconnect',{method:'DELETE'}); if(res.ok){ await loadConnectionStatus(); alert('QuickBooks disconnected successfully'); } else { throw new Error('Failed'); } }
  catch(e){ console.error('Failed to disconnect:',e); alert('Failed to disconnect QuickBooks.'); }
}

async function syncAllExpenses(){
  if(syncInProgress) return; syncInProgress=true; showSyncProgress();
  try{ const res=await fetch('/api/integrations/quickbooks/sync',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})}); const data=await res.json(); if(data.success){ updateSyncProgress(100, `${data.synced_count} expenses synced successfully`); setTimeout(()=>{ hideSyncProgress(); loadConnectionStatus(); loadSyncHistory(); },2000);} else { showSyncErrors(data.errors); } }
  catch(e){ console.error('Sync failed:',e); showSyncErrors(['Failed to sync expenses. Please try again.']); }
  finally{ syncInProgress=false; }
}

async function testConnection(){
  try{ const res=await fetch('/api/integrations/quickbooks/status'); const data=await res.json(); alert(data.is_connected?'Connection test successful!':'Connection test failed. Please connect to QuickBooks first.'); }
  catch(e){ console.error('Connection test failed:',e); alert('Connection test failed.'); }
}

async function loadSyncHistory(){
  try{ const res=await fetch('/api/integrations/quickbooks/sync/history?limit=50'); const data=await res.json(); if(data.sync_history?.length){ syncHistory.innerHTML=(window.CORASecurity?.createSafeSyncHistory) ? window.CORASecurity.createSafeSyncHistory(data.sync_history) : data.sync_history.map(h=>`<tr><td class=\"px-6 py-4\">${new Date(h.date).toLocaleDateString()}</td><td class=\"px-6 py-4\">${h.type}</td><td class=\"px-6 py-4\">${h.status}</td><td class=\"px-6 py-4\">${h.details||'-'}</td></tr>`).join(''); } else { syncHistory.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No sync history available</td></tr>'; } }
  catch(e){ console.error('Failed to load sync history:',e); syncHistory.innerHTML='<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Failed to load sync history</td></tr>'; }
}

function showSyncProgress(){ syncProgress?.classList.remove('hidden'); updateSyncProgress(0,'Starting sync...'); }
function hideSyncProgress(){ syncProgress?.classList.add('hidden'); }
function updateSyncProgress(pct,status){ if(!syncBar||!syncStatus||!syncCount) return; syncBar.style.width=`${pct}%`; syncStatus.textContent=status; syncCount.textContent=`${Math.round(pct)}%`; }
function showSyncErrors(errors){ if(!syncErrors) return; syncErrors.innerHTML=(window.CORASecurity?.createSafeErrorList) ? window.CORASecurity.createSafeErrorList(errors) : `<div class=\"text-red-600\">${(errors||[]).join('<br>')}</div>`; syncErrors.classList.remove('hidden'); }
</script>
{% endblock %} 