{% extends "base_app.html" %}

{% block page_title %}Stripe Integration - CORA{% endblock %}

{% block page_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<!-- Legacy wellness.css removed; rely on base_app theme -->
<link rel="stylesheet" href="/static/css/mobile-navigation.css">
<style>
  .card-hover{transition:transform .2s ease, box-shadow .2s ease}
  .card-hover:hover{transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,0.08)}
  .status-connected{background:#16a34a}
  .status-disconnected{background:#ef4444}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-8">
    <div class="flex items-center mb-4">
      <div class="h-12 w-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center mr-4">
        <i class="fas fa-credit-card text-white text-xl"></i>
      </div>
      <div>
        <h1 class="text-3xl font-bold text-gray-100">Stripe Integration</h1>
        <p class="text-gray-300">Sync your Stripe transactions automatically</p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Connection Status</h3>
        <div id="status-indicator" class="w-3 h-3 rounded-full"></div>
      </div>
      <div id="connection-info"><p class="text-sm text-gray-600 mb-2">Checking connection...</p></div>
      <div class="mt-4">
        <button id="connect-btn" class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors hidden"><i class="fas fa-plug mr-2"></i>Connect Stripe</button>
        <button id="disconnect-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors hidden"><i class="fas fa-unlink mr-2"></i>Disconnect</button>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Sync Statistics</h3>
      <div class="space-y-3">
        <div class="flex justify-between"><span class="text-sm text-gray-600">Transactions Synced:</span><span id="total-synced" class="font-semibold">-</span></div>
        <div class="flex justify-between"><span class="text-sm text-gray-600">Total Amount:</span><span id="total-amount" class="font-semibold">-</span></div>
        <div class="flex justify-between"><span class="text-sm text-gray-600">Last Sync:</span><span id="last-sync" class="font-semibold">-</span></div>
        <div class="flex justify-between"><span class="text-sm text-gray-600">Auto Sync:</span><span id="auto-sync" class="font-semibold">-</span></div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
      <div class="space-y-3">
        <button id="sync-transactions-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-sync mr-2"></i>Sync Transactions</button>
        <button id="view-transactions-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-list mr-2"></i>View Transactions</button>
        <button id="test-connection-btn" class="w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors"><i class="fas fa-wifi mr-2"></i>Test Connection</button>
      </div>
    </div>
  </div>

  <div id="transactions-section" class="bg-white rounded-lg shadow-sm border mb-8 hidden">
    <div class="px-6 py-4 border-b"><h3 class="text-lg font-semibold text-gray-900">Recent Transactions</h3></div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50"><tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr></thead>
        <tbody id="transactions-list" class="bg-white divide-y divide-gray-200"><tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading transactions...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm border">
    <div class="px-6 py-4 border-b"><h3 class="text-lg font-semibold text-gray-900">Sync History</h3></div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50"><tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
        </tr></thead>
        <tbody id="sync-history" class="bg-white divide-y divide-gray-200"><tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading sync history...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
let isConnected=false, syncInProgress=false;
const statusIndicator=document.getElementById('status-indicator');
const connectionInfo=document.getElementById('connection-info');
const connectBtn=document.getElementById('connect-btn');
const disconnectBtn=document.getElementById('disconnect-btn');
const syncTransactionsBtn=document.getElementById('sync-transactions-btn');
const viewTransactionsBtn=document.getElementById('view-transactions-btn');
const testConnectionBtn=document.getElementById('test-connection-btn');
const syncProgress=document.getElementById('sync-progress');
const syncStatus=document.getElementById('sync-status');
const syncCount=document.getElementById('sync-count');
const syncBar=document.getElementById('sync-bar');
const syncErrors=document.getElementById('sync-errors');
const syncHistory=document.getElementById('sync-history');
const transactionsSection=document.getElementById('transactions-section');
const transactionsList=document.getElementById('transactions-list');

document.addEventListener('DOMContentLoaded',()=>{ loadConnectionStatus(); loadSyncHistory(); });
connectBtn?.addEventListener('click', connectStripe);
disconnectBtn?.addEventListener('click', disconnectStripe);
syncTransactionsBtn?.addEventListener('click', syncTransactions);
viewTransactionsBtn?.addEventListener('click', viewTransactions);
testConnectionBtn?.addEventListener('click', testConnection);

async function loadConnectionStatus(){
  try{ const res=await fetch('/api/integrations/stripe/status'); const data=await res.json(); isConnected=data.is_connected; updateConnectionUI(data);}catch(e){ console.error('Failed to load connection status:',e); updateConnectionUI({is_connected:false}); }
}

function updateConnectionUI(data){
  if(data.is_connected){
    statusIndicator.className='w-3 h-3 rounded-full status-connected';
    const name=(window.CORASecurity?.sanitizeHtml?.(data.business_name)||data.business_name)||'Stripe Account';
    connectionInfo.innerHTML=`<p class='text-sm text-gray-600 mb-2'>Connected to:</p><p class='font-semibold text-gray-900'>${name}</p>`;
    connectBtn.classList.add('hidden');
    disconnectBtn.classList.remove('hidden');
    syncTransactionsBtn.disabled=false; viewTransactionsBtn.disabled=false;
    document.getElementById('total-synced').textContent=data.total_transactions_synced||0;
    document.getElementById('total-amount').textContent=data.total_amount_synced?`$${data.total_amount_synced.toFixed(2)}`:'$0.00';
    document.getElementById('last-sync').textContent=data.last_sync_at?new Date(data.last_sync_at).toLocaleDateString():'Never';
    document.getElementById('auto-sync').textContent=data.auto_sync_enabled?'Enabled':'Disabled';
  } else {
    statusIndicator.className='w-3 h-3 rounded-full status-disconnected';
    connectionInfo.innerHTML='<p class="text-sm text-gray-600">Not connected to Stripe</p>';
    connectBtn.classList.remove('hidden');
    disconnectBtn.classList.add('hidden');
    syncTransactionsBtn.disabled=true; viewTransactionsBtn.disabled=true;
    document.getElementById('total-synced').textContent='-';
    document.getElementById('total-amount').textContent='-';
    document.getElementById('last-sync').textContent='-';
    document.getElementById('auto-sync').textContent='-';
  }
}

async function connectStripe(){
  try{ const res=await fetch('/api/integrations/stripe/auth'); const data=await res.json(); if(data.auth_url){ window.location.href=data.auth_url; } else { throw new Error('Failed to get auth URL'); } }
  catch(e){ console.error('Failed to connect:',e); alert('Failed to connect to Stripe. Please try again.'); }
}

async function disconnectStripe(){
  if(!confirm('Are you sure you want to disconnect Stripe?')) return;
  try{ const res=await fetch('/api/integrations/stripe/disconnect',{method:'DELETE'}); if(res.ok){ await loadConnectionStatus(); alert('Stripe disconnected successfully'); } else { throw new Error('Failed'); } }
  catch(e){ console.error('Failed to disconnect:',e); alert('Failed to disconnect Stripe.'); }
}

async function syncTransactions(){
  if(syncInProgress) return; syncInProgress=true; showSyncProgress();
  try{ const res=await fetch('/api/integrations/stripe/sync',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ limit:100 })}); const data=await res.json(); if(data.success){ updateSyncProgress(100, `${data.synced_count} transactions synced successfully`); setTimeout(()=>{ hideSyncProgress(); loadConnectionStatus(); loadSyncHistory(); },2000);} else { showSyncErrors(data.errors); } }
  catch(e){ console.error('Sync failed:',e); showSyncErrors(['Failed to sync transactions. Please try again.']); }
  finally{ syncInProgress=false; }
}

async function viewTransactions(){
  try{ showLoading(); const res=await fetch('/api/integrations/stripe/transactions?limit=50'); const data=await res.json(); if(data.transactions?.length){ displayTransactions(data.transactions); transactionsSection.classList.remove('hidden'); } else { alert('No transactions found.'); } }
  catch(e){ console.error('Failed to load transactions:',e); alert('Failed to load transactions.'); }
  finally{ hideLoading(); }
}

function displayTransactions(transactions){
  const rows=(window.CORASecurity?.createSafeTransactionRows) ? window.CORASecurity.createSafeTransactionRows(transactions) : transactions.map(t=>`<tr><td class=\"px-6 py-4\">${new Date(t.date).toLocaleDateString()}</td><td class=\"px-6 py-4\">${t.description||''}</td><td class=\"px-6 py-4\">$${(+t.amount||0).toFixed(2)}</td><td class=\"px-6 py-4\">${t.status||''}</td><td class=\"px-6 py-4\">—</td></tr>`).join('');
  transactionsList.innerHTML=rows;
}

async function testConnection(){
  try{ showLoading(); const res=await fetch('/api/integrations/stripe/status'); const data=await res.json(); alert(data.is_connected?'Connection test successful!':'Connection test failed. Please connect to Stripe first.'); }
  catch(e){ console.error('Connection test failed:',e); alert('Connection test failed.'); }
  finally{ hideLoading(); }
}

async function loadSyncHistory(){
  try{ const res=await fetch('/api/integrations/stripe/sync/history?limit=50'); const data=await res.json(); if(data.sync_history?.length){ syncHistory.innerHTML=(window.CORASecurity?.createSafeSyncHistory) ? window.CORASecurity.createSafeSyncHistory(data.sync_history) : data.sync_history.map(h=>`<tr><td class=\"px-6 py-4\">${new Date(h.date).toLocaleDateString()}</td><td class=\"px-6 py-4\">${h.type}</td><td class=\"px-6 py-4\">${h.status}</td><td class=\"px-6 py-4\">${h.amount||'-'}</td><td class=\"px-6 py-4\">${h.duration||'-'}</td><td class=\"px-6 py-4\">${h.details||'-'}</td></tr>`).join(''); } else { syncHistory.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No sync history available</td></tr>'; } }
  catch(e){ console.error('Failed to load sync history:',e); syncHistory.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load sync history</td></tr>'; }
}

function showSyncProgress(){ if(!syncProgress) return; syncProgress.classList.remove('hidden'); updateSyncProgress(0,'Starting sync...'); }
function hideSyncProgress(){ syncProgress?.classList.add('hidden'); }
function updateSyncProgress(pct,status){ if(!syncBar||!syncStatus||!syncCount) return; syncBar.style.width=`${pct}%`; syncStatus.textContent=status; syncCount.textContent=`${Math.round(pct)}%`; }
function showSyncErrors(errors){ if(!syncErrors) return; syncErrors.innerHTML=(window.CORASecurity?.createSafeErrorList) ? window.CORASecurity.createSafeErrorList(errors) : `<div class=\"text-red-600\">${(errors||[]).join('<br>')}</div>`; syncErrors.classList.remove('hidden'); }
function showLoading(){}
function hideLoading(){}
</script>
{% endblock %} 